<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Nested List Sample</title>
  <link rel="stylesheet" href="js/resources/css/ext-touch.css" type="text/css" />
  <style type="text/css">
  	.x-list-item {
	    background-image: url(img/chevron.png);
	    background-position: right center;
	    background-repeat: no-repeat;
		}
  </style>
  <script type="text/javascript" src="js/jquery.1.3.2.min.js"></script>
  <script type="text/javascript" src="js/ext-touch-debug.js"></script>
  <script type="text/javascript">
    Ext.setup({
    	onReady: function() {

				Ext.regModel("SchemaItem", {
					fields: [
						{name: "table_schema", type: "string"}
					]
				});

				var dbStore = new Ext.data.TreeStore({
					model: "SchemaItem",
					proxy: {
						type: "ajax",
						url: "databases",
						reader: {
							type: "tree"
						}
					}
				});

    		var list = new Ext.NestedList({
    			fullscreen: true,
    			title: "DB",
    			displayField: "table_schema",
    			store: dbStore
    		});

				//アイテム選択時の処理
				list.on("beforeselect", function(subList, el, node) {
					var rec = subList.getStore().getAt(el.viewIndex);

					var schema = rec.get("table_schema");

					//table_schema 表示時にだけテーブル一覧の取得処理を実行
					if (schema) {
						var req = new jQuery.ajax({
							method: "get",
							url: "tables/" + rec.get("table_schema"),
							async: false
						});

						var jsonObj = eval("(" + req.responseText + ")");

						Ext.each(jsonObj, function(item, index, allItems) {
							//data が未定義時にエラーが発生するため
							item.data = [];

							//テーブル情報を選択ノードの子として追加
							rec.node.appendChild(new Ext.data.Node({
								record: item,
								leaf: true
							}));
						});

						list.displayField = "table_name";
					}
				});
    	}
    });
</script>
</head>
<body>
</body>
</html>
