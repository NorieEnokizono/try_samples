<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Nested List Sample(jQuery Mobile)</title>
	<link rel="stylesheet"  href="js/jquery.mobile-1.0a1.min.css" />
	<script src="js/jquery-1.4.3.min.js"></script>
	<script src="js/jquery.mobile-1.0a1.min.js"></script>
	<script>
		$(function() {

			$.get("databases", null, function(res) {
				var html = "<ul>";

				$.each(res, function() {
					html += "<li>" + this.table_schema + "<ul /></li>";
				});

				html += "</ul>";

				$("#db_list").append(html);

				var dbEl = $("#db_list > ul");

				dbEl.listview();

				dbEl.find("li").tap(function(event) {
					var alink = $(event.currentTarget).find("a");
					var db = alink.text();
					var targetId = alink.attr("href").replace("#", "");

					$.get("tables/" + db, null, function(res2) {
						var el = $("[id='" + targetId + "']").find(".ui-content > ul");
						var parentEl = el.parent();

						//listview() を実行させるため、既存のul要素を削除しておく必要あり
						el.remove();

						var html2 = "<ul>";

						$.each(res2, function() {
							html2 += "<li>" + this.table_name + "<ul data-inset='true'>" + createDetail(this) + "</ul></li>";
						});

						html2 += "</ul>";

						parentEl.append(html2);
						//新しく追加した ul に listview() を適用
						parentEl.find("ul").listview();

					}, "json");
				});

			}, "json");
		});

		//詳細ページのHTMLを作成
		function createDetail(item) {
			var headers = ["table_name", "table_type", "engine", "create_time"];
			var html = "<li><table>";

			$.each(headers, function() {
				html += "<tr>";
				html += "<th>" + this + "</th><td>:</td>";
				html += "<td>" + item[this] + "</td>";
				html += "</tr>";
			});

			html += "</table></li>";
			return html;
		}

	</script>
</head>
<body>
	<!-- ページ -->
	<div data-role="page">
		<!-- ヘッダー -->
		<div data-role="header" data-theme="b">
			<h1>DB</h1>
		</div>
		<!-- 内容 -->
		<div id="db_list" data-role="content">
		</div>
	</div>

</body>
</html>
